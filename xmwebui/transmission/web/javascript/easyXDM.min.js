/*
 * easyXDM 
 * http://easyxdm.net/
 * Copyright(c) 2009, Ã˜yvind Sean Kinsey, oyvind@kinsey.no.
 * 
 * MIT Licensed - http://easyxdm.net/license/mit.txt
 * 
 */
 easyXDM={version:"1.6.0.40",apply:function(c,b){if(!b){return}for(var a in b){if(b.hasOwnProperty(a)){c[a]=b[a]}}},Interface:function(b,c,g){var f;var i=0,h={};function e(k,j){if(typeof k.scope==="undefined"){k.scope=window}if(k.isVoid){return function(){var l=Array.prototype.slice.call(arguments,0);window.setTimeout(function(){f.sendData({name:j,params:l})},0)}}else{return function(){h[""+(++i)]=arguments[arguments.length-1];var l={name:j,id:(i),params:Array.prototype.slice.call(arguments,0,arguments.length-1)};window.setTimeout(function(){f.sendData(l)},0)}}}function d(j,m,l,k){if(!l){throw new Error("The method "+j+" is not implemented.")}if(l.isAsync){k.push(function(n){f.sendData({id:m,response:n})});l.method.apply(l.scope,k)}else{if(l.isVoid){l.method.apply(l.scope,k)}else{f.sendData({id:m,response:l.method.apply(l.scope,k)})}}}b.converter=c.serializer||JSON;b.onData=function(k,j){if(k.name){d(k.name,k.id,c.local[k.name],k.params)}else{h[k.id](k.response);delete h[k.id]}};this.destroy=function(){f.destroy();for(var j in this){if(this.hasOwnProperty(j)){delete this[j]}}};if(c.remote){for(var a in c.remote){if(c.remote.hasOwnProperty(a)){this[a]=e(c.remote[a],a)}}}window.setTimeout(function(){f=new easyXDM.Channel(b,g)},5)},Channel:function(a,c){a.serializer=a.serializer||a.converter;if(!a.serializer){throw new Error("No serializer present. You should use the easyXDM.transport classes directly.")}a.onMessage=function(e,d){this.onData(this.serializer.parse(e),d)};this.transport=null;this.destroy=function(){this.transport.destroy()};this.sendData=function(d){this.transport.postMessage(a.serializer.stringify(d))};var b=this;window.setTimeout(function(){b.transport=new easyXDM.transport.BestAvailableTransport(a,c)},5)}};easyXDM.DomHelper={createFrame:function(c,a,e,b){var g;var f=document.getElementsByTagName("FRAMESET");if(b&&window.attachEvent){var d=document.createElement("span");document.body.appendChild(d);d.innerHTML='<iframe style="position:absolute;left:-2000px;" src="'+c+'" id="'+b+'" name="'+b+'"></iframe>';g=document.getElementById(b);if(e){this.addEventListener(g,"load",function(){e(g.contentWindow)})}}else{if(!a&&f&&f.length>0){g=document.createElement("FRAME");g.src=c;if(e){this.addEventListener(g,"load",function(){e(g.contentWindow)})}f[0].appendChild(g)}else{g=document.createElement("IFRAME");g.src=c;if(e){this.addEventListener(g,"load",function(){e(g.contentWindow)})}if(a){a.appendChild(g)}else{g.style.position="absolute";g.style.left="-2000px";document.body.appendChild(g)}}if(b){g.id=g.name=b}}return g},addEventListener:function(d,b,c,a){if(window.addEventListener){easyXDM.DomHelper.addEventListener=function(h,f,g,e){h.addEventListener(f,g,e)}}else{easyXDM.DomHelper.addEventListener=function(e,g,f){e.attachEvent("on"+g,f)}}easyXDM.DomHelper.addEventListener(d,b,c)},removeEventListener:function(e,b,d,a){var c;if(window.removeEventListener){c=function(i,g,h,f){i.removeEventListener(g,h,f)}}else{c=function(f,h,g){f.detachEvent("on"+h,g)}}c(e,b,d);easyXDM.DomHelper.removeEventListener=c},requiresJSON:function(a){if(typeof JSON=="undefined"||!JSON){document.write('<script type="text/javascript" src="'+a+'"><\/script>')}}};easyXDM.transport={BestAvailableTransport:function(a,d){if(a.local){a.channel=(a.channel)?a.channel:"default"}else{var c=easyXDM.Url.Query();if(typeof c.endpoint!=="string"){throw ("No remote specified")}a.channel=c.channel;a.remote=c.endpoint}var b="HashTransport";if(window.postMessage){b="PostMessageTransport"}return new easyXDM.transport[b](a,d)},PostMessageTransport:function(a,e){if(!window.postMessage){throw new Error("This browser does not support window.postMessage")}var j,d=easyXDM.Url.getLocation(a.remote),g;function b(k){if(k.origin){return k.origin}if(k.uri){return easyXDM.Url.getLocation(k.uri)}if(k.domain){return location.protocol+"//"+k.domain}throw"Unable to retrieve the origin of the event"}function c(){if(e){window.setTimeout(e,5)}}function h(k){g(k)}easyXDM.DomHelper.addEventListener(window,"message",h);function i(l){var k=b(l);if(k==d&&l.data.substring(0,a.channel.length+1)==a.channel+" "){a.onMessage(l.data.substring(a.channel.length+1),k)}}function f(k){if(k.data==a.channel+"-ready"){g=i;c()}}this.destroy=function(){easyXDM.DomHelper.removeEventListener(window,"message",h);if(a.local){j.parentNode.removeChild(j);j=null}};this.postMessage=(function(){if(a.local){g=f;j=easyXDM.DomHelper.createFrame(easyXDM.Url.appendQueryParameters(a.remote,{endpoint:easyXDM.Url.resolveUrl(a.local),channel:a.channel}),a.container);return function(k){j.contentWindow.postMessage(a.channel+" "+k,d)}}else{g=i;window.parent.postMessage(a.channel+"-ready",d);c();return function(k){window.parent.postMessage(a.channel+" "+k,d)}}}())},HashTransport:function(d,i){var e,b=d.interval||300,l=false,k=false,a=true;var g="#"+d.channel,q=0,f,n;var p,c=easyXDM.Url.getLocation(d.remote);if(d.local){var m={channel:d.channel};if(d.local===window){l=true;k=true;d.local=location.protocol+"//"+location.host+location.pathname+location.search;m.parent=1}if(d.container){a=false;m.poll=1}m.endpoint=easyXDM.Url.resolveUrl(d.local);p=easyXDM.Url.appendQueryParameters(d.remote,m)}else{var j=easyXDM.Url.Query();f=window;k=(typeof j.parent!=="undefined");l=(typeof j.poll!=="undefined");p=d.remote+"#"+d.channel}function o(){try{if(f.location.hash&&f.location.hash!=g){g=f.location.hash;d.onMessage(decodeURIComponent(g.substring(g.indexOf("_")+1)),c)}}catch(r){}}function h(){if(d.local){if(k){f=window}else{if(d.readyAfter){f=window.open(d.local+"#"+d.channel,"remote_"+d.channel)}else{f=easyXDM.transport.HashTransport.getWindow(d.channel)}if(!f){throw new Error("Failed to obtain a reference to the window")}}}if(l){e=window.setInterval(function(){o()},b)}else{easyXDM.DomHelper.addEventListener(f,"resize",o)}if(i){window.setTimeout(i,10)}}this.postMessage=function(r){if(d.local||!k){n.src=p+"#"+(q++)+"_"+encodeURIComponent(r);if(a){n.width=n.width>75?50:100}}else{n.location=p+"#"+(q++)+"_"+encodeURIComponent(r)}};this.destroy=function(){if(l){window.clearInterval(e)}else{if(f){easyXDM.DomHelper.removeEventListener(f,"resize",o)}}if(d.local||!k){n.parentNode.removeChild(n)}n=null};if(d.local){if(d.readyAfter){window.setTimeout(h,d.readyAfter)}else{easyXDM.transport.HashTransport.registerOnReady(d.channel,h)}}if(!d.local&&k){n=parent;h()}else{n=easyXDM.DomHelper.createFrame(p,d.container,(d.local&&!k)?null:h,(d.local?"local_":"remote_")+d.channel)}}};easyXDM.transport.HashTransport.callbacks={};easyXDM.transport.HashTransport.windows={};easyXDM.transport.HashTransport.registerOnReady=function(a,b){easyXDM.transport.HashTransport.callbacks[a]=b};easyXDM.transport.HashTransport.channelReady=function(d,a){var b=easyXDM.transport.HashTransport;b.windows[d]=a;var c=b.callbacks[d];if(c){c();delete b.callbacks[d]}};easyXDM.transport.HashTransport.getWindow=function(a){return easyXDM.transport.HashTransport.windows[a]};easyXDM.Url={Query:function(){if(this._query){return this._query}this._query={};var f,d,e,c=location.search.substring(1).split("&");for(var b=0,a=c.length;b<a;b++){f=c[b];d=f.substring(0,f.indexOf("="));e=f.substring(d.length+1);this._query[d]=e}return this._query},getDomainName:function(a){var c=a.substring(a.indexOf("//")+2);c=c.substring(0,c.indexOf("/"));var b=c.indexOf(":");if(b!=-1){c=c.substring(0,b)}return c},getLocation:function(a){var b=a.indexOf("//");var c=a.substring(b+2);c=c.substring(0,c.indexOf("/"));return a.substring(0,b+2)+c},resolveUrl:function(a){if(a.match(/^(http||https):\/\//)){return a}if(a.substring(0,1)=="/"){return location.protocol+"//"+location.host+a}return location.href.substring(0,location.href.lastIndexOf("/")+1)+a},appendQueryParameters:function(a,c){var d="";for(var b in c){if(c.hasOwnProperty(b)){d+=b+"="+c[b]+"&"}}return a+((a.indexOf("?")==-1)?"?":"&")+d.substring(0,d.length-1)}};easyXDM.serializing={hashTableSerializer:{stringify:function(c){var b="";for(var a in c){if(c.hasOwnProperty(a)){b+=a+"="+escape(c[a])+"&"}}return b.substring(0,b.length-1)},parse:function(e){var g={};var j=e.split("&");var h,c,f;for(var b=0,a=j.length;b<a;b++){h=j[b];c=h.substring(0,h.indexOf("="));f=h.substring(c.length+1);g[c]=unescape(f)}return g}}};